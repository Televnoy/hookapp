<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <title>Hook App | Professional Tool</title>
    
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
    
    <!-- PWA Assets -->
    <link rel="manifest" href='data:application/json;base64,ewogICJuYW1lIjogIkhvb2sgQXBwIiwKICAic2hvcnRfbmFtZSI6ICJIb29rIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNGRkZGRkYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTExODI3IiwKICAiaWNvbnMiOiBbCiAgICB7ICJzcmMiOiAiaWNvbi0xOC5wbmciLCAic2l6ZXMiOiAiMTh4MTgiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0zMi5wbmciLCAic2l6ZXMiOiAiMzJ4MzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi00OC5wbmciLCAic2l6ZXMiOiAiMzJ4MzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi03Mi5wbmciLCAic2l6ZXMiOiAiNzJ4NzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi05Ni5wbmciLCAic2l6ZXMiOiAiOTZ4OTYiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0xNDQucG5nIiwgInNpemVzIjogIjE0NHgxNDQiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0xOTIucG5nIiwgInNpemVzIjogIjE5MngxOTIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi01MTIucG5nIiwgInNpemVzIjogIjUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0KICBdCn0='>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBk99RmIn2McXhLlMV4huc2iTUGONc7Zig",
            authDomain: "rootscalc-1c302.firebaseapp.com",
            projectId: "rootscalc-1c302",
            storageBucket: "rootscalc-1c302.firebasestorage.app",
            messagingSenderId: "466620468252",
            appId: "1:466620468252:web:e65ad3b731f4315f06a3d9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'rootscalc-pro';

        window.firebaseTools = { db, auth, appId, doc, getDoc, updateDoc, setDoc, signInAnonymously };
        signInAnonymously(auth).catch(err => console.error("Firebase Auth Error:", err.code));
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --charcoal: #111827; 
            --soft-gray: #9CA3AF; 
            --border: #E5E7EB; 
            --bg-main: #FFFFFF;
            --text-main: #111827;
            --panel-bg: #FFFFFF;
            --header-bg: rgba(255, 255, 255, 0.85);
            --thumb-bg: #FFFFFF;
        }

        body.contrast-mode {
            --bg-main: #000000;
            --text-main: #FFFFFF;
            --charcoal: #FFFFFF;
            --soft-gray: #6B7280;
            --border: #262626;
            --panel-bg: #000000;
            --header-bg: rgba(0, 0, 0, 0.85);
            --thumb-bg: #000000;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); margin: 0; padding: 0; overflow-x: hidden; user-select: none; -webkit-font-smoothing: antialiased; transition: background 0.3s, color 0.3s; }
        #splatterCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFFFFF; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #preloader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .spinner {
            width: 40px; height: 40px; border: 2px solid #f3f3f3;
            border-top: 2px solid #111827; border-radius: 50%;
            animation: spin 1s linear infinite; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sticky-header { position: sticky; top: 0; z-index: 50; background: var(--header-bg); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header-title { letter-spacing: 0.3em; text-transform: uppercase; font-weight: 700; font-size: 0.8rem; }
        .demo-timer { font-size: 0.7rem; font-weight: 700; color: #000000; letter-spacing: 0.1em; } 
        .info-btn { font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; border: 1px solid var(--charcoal); padding: 0.4rem 0.8rem; cursor: pointer; font-weight: 600; color: var(--text-main); }
        
        .main-container { max-width: 600px; margin: 0 auto; padding: 2rem 1.5rem 14rem; }
        
        #lockOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; text-align: center; }
        .key-input { width: 100%; max-width: 300px; border: 1px solid var(--charcoal); background: transparent; color: var(--text-main); padding: 1rem; margin: 1.5rem 0; text-align: center; font-family: monospace; letter-spacing: 2px; text-transform: uppercase; outline: none; }
        
        .section-label { letter-spacing: 0.25em; text-transform: uppercase; font-size: 0.6rem; font-weight: 600; color: var(--soft-gray); margin-bottom: 1.5rem; display: block; }
        .input-group { border-bottom: 1px solid var(--border); padding-bottom: 2rem; margin-bottom: 2rem; }
        
        .service-selector { display: flex; gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 3rem; }
        .service-option { flex: 1; background: var(--bg-main); padding: 1rem; text-align: center; cursor: pointer; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.15em; font-weight: 500; transition: all 0.2s; color: var(--text-main); }
        .service-option.active { background: var(--charcoal); color: var(--bg-main); }
        
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 1px; background: var(--border); outline: none; margin: 1.5rem 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--thumb-bg); border: 1px solid var(--charcoal); border-radius: 50%; cursor: pointer; }
        
        .display-value { font-weight: 100; font-size: 3.5rem; line-height: 1; letter-spacing: -0.02em; }
        .unit { font-size: 0.9rem; color: var(--soft-gray); margin-left: 0.5rem; font-weight: 300; }
        
        .custom-checkbox { display: flex; align-items: center; cursor: pointer; padding: 0.75rem 0; }
        .custom-checkbox input { display: none; }
        .checkmark { width: 20px; height: 20px; border: 1px solid var(--charcoal); margin-right: 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .custom-checkbox input:checked + .checkmark { background: var(--charcoal); }
        .custom-checkbox input:checked + .checkmark::after { content: ''; width: 6px; height: 6px; background: var(--bg-main); }
        
        .sub-control { max-height: 0; overflow: hidden; padding-left: 2rem; border-left: 1px solid var(--border); opacity: 0; transition: all 0.4s ease; }
        .sub-control.active { max-height: 500px; opacity: 1; margin-top: 1rem; margin-bottom: 2rem; }
        
        .result-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel-bg); border-top: 1px solid var(--charcoal); padding: 2rem 1.5rem calc(2rem + env(safe-area-inset-bottom)); max-width: 600px; margin: 0 auto; z-index: 40; }
        .price-display { font-weight: 100; font-size: 4rem; letter-spacing: -0.05em; line-height: 1; }
        
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 100; display: none; overflow-y: auto; padding: 2rem 1.5rem; color: var(--text-main); }
        .settings-table { width: 100%; margin-bottom: 2rem; }
        .settings-table td { padding: 0.8rem 0; border-bottom: 1px solid var(--border); }
        .settings-table input { width: 80px; border: 1px solid var(--border); background: transparent; color: var(--text-main); padding: 0.3rem; text-align: right; font-weight: 600; outline: none; }
        
        .save-btn { background: var(--charcoal); color: var(--bg-main); width: 100%; padding: 1.2rem; text-transform: uppercase; letter-spacing: 0.2em; font-size: 0.75rem; font-weight: 700; transition: opacity 0.2s; }
        .save-btn:active { opacity: 0.7; }
        .hidden-element { display: none !important; }
        .theme-switch-row { display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 0; border-bottom: 1px solid var(--border); margin-bottom: 2.5rem; }
    </style>
</head>
<body>

    <div id="preloader">
        <svg class="loader-logo" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="60" height="60" viewBox="0 0 75 420" fill="none">
<path 
    d="M37.41 15.54c-.01-.56-.04-1.11-.07-1.67-.03-.48-.08-.96-.1-1.44-.03-.69-.08-1.38-.16-2.07-.07-.61-.12-1.22-.19-1.83-.09-.84-.22-1.68-.35-2.52-.08-.55-.21-1.09-.32-1.64-.05-.22-.09-.45-.17-.66 0-.05 0-.11-.02-.16-.19-.64-.37-1.29-.69-1.88-.15-.27-.29-.54-.48-.79-.06-.14-.2-.22-.31-.33-.01-.05-.05-.07-.1-.08-.08-.07-.15-.15-.25-.18a.54.54 0 0 0-.27-.14c-.24-.09-.48-.17-.75-.14-.14.01-.28 0-.42 0-.06 0-.12 0-.18.03-.05 0-.11 0-.15.04-.14.02-.26.07-.38.15-.09 0-.15.06-.21.12-.13.06-.23.16-.34.26-.04 0-.06.03-.07.07-.09.08-.19.14-.23.26-.17.21-.33.43-.45.67-.04.04-.06.09-.07.15 0 .01-.01.03-.02.04-.07.14-.14.28-.19.43-.14.42-.28.84-.42 1.27-.14.45-.25.92-.34 1.38-.05.24-.12.47-.15.7-.07.46-.14.92-.2 1.37-.04.28-.09.55-.09.83-.01.07-.03.14-.04.22-.07.46-.13.93-.17 1.4l-.15 1.59c-.03.37-.04.74-.08 1.11-.11 1.02-.14 2.05-.19 3.07-.02.45-.03.89-.05 1.33-.03.6-.06 1.2-.06 1.8 0 1.55-.03 3.09.03 4.64.01.41.03.82.05 1.22l.03.78c.07.98.18 1.96.27 2.94.02.23.02.46.09.68 0 .18.03.35.06.51.06.45.14.9.21 1.35.14.93.27 1.86.42 2.79.1.66.21 1.32.31 1.98.09.61.14 1.21.21 1.82.12 1.11.17 2.22.23 3.33.02.37.04.74.05 1.11v.2l.12 4.49c.01.48.01.95.03 1.43.03.64.03 1.27.09 1.91.03.42.02.84.07 1.26.04.39.08.79.13 1.18.05.44.12.87.2 1.3.03.28.1.56.16.84.18.85.42 1.69.7 2.52.03.1.05.2.11.29.12.35.24.7.41 1.03.24.46.42.95.64 1.42.28.6.5 1.22.59 1.89v.21c0 .11-.02.12-.15.08a.25.25 0 0 0-.08-.18c-.14-.34-.44-.51-.75-.66-.09-.04-.19-.05-.26-.11-.03-.04-.07-.05-.11-.06-.27-.06-.53-.05-.78.09-.08.04-.18.04-.25.11-.12.08-.24.15-.3.3-.08.08-.14.17-.15.29-.12.24-.17.5-.18.77-.02.53.09 1.05.22 1.56.11.45.33.87.53 1.28.19.37.44.69.79.92.31.2.63.28.98.1.28-.08.45-.29.6-.52.1-.15.16-.33.21-.51.08-.28.16-.56.23-.84q.12-.45.15-.93c.07-.29.11-.59.11-.89.04-.11.04-.22.04-.33.03-.06.03-.12.04-.18.07-.49.08-.98.12-1.46l.18-2.07c.04-.45.05-.9.1-1.35.03-.28.05-.56.07-.83.03-.53.05-1.06.09-1.59.07-1.03.14-2.05.18-3.08.05-1.26.1-2.52.12-3.79 0-.74.01-1.47.04-2.21.04-1.24.02-2.48.09-3.71.03-.56.03-1.11.05-1.67 0-.31.04-.62.05-.93.02-.39.07-.78.06-1.17.01-.05.02-.1.02-.16.02-.19.05-.39.06-.58.08-.97.2-1.94.34-2.91.11-.81.22-1.62.38-2.42.02-.1.03-.2.02-.29.03-.04.03-.08.03-.12.07-.45.12-.89.2-1.34.15-.84.22-1.69.32-2.54.04-.33.05-.67.08-1 .04-.51.1-1.02.12-1.53.04-.98.07-1.95.09-2.93.02-.76.02-1.51.02-2.27 0-1.41-.03-2.81-.06-4.21ZM32.57.05h-.01s.01 0 .02-.01" 
    fill="#111827"
  />        </svg>
        <div class="header-title mt-4" style="color: #111827">hook app</div>
        <div class="spinner"></div>
    </div>

    <canvas id="splatterCanvas"></canvas>

    <div id="lockOverlay">
        <div class="header-title mb-8">hook app</div>
        <p class="text-xs uppercase tracking-widest text-gray-400 mb-2">Пробный период завершен</p>
        <h2 class="text-xl font-light mb-6">Активация устройства</h2>
        <input type="text" id="activationKey" class="key-input" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
        <button id="activateBtn" onclick="checkKey()" class="save-btn max-w-[300px]">Активировать</button>
        <p id="keyError" class="mt-4 text-[10px] text-red-500 uppercase tracking-widest hidden">Ошибка</p>
        <div class="mt-10 pt-10 border-t w-full max-w-[300px] border-border">
            <p class="text-[9px] uppercase tracking-widest text-gray-400">ID устройства:</p>
            <p id="deviceIdLabel" class="text-[9px] font-mono mt-1 opacity-50">загрузка...</p>
        </div>
    </div>

    <header class="sticky-header">
        <div class="header-title">hook app</div>
        <div id="demoTimer" class="demo-timer">DEMO 30:00</div>
        <div class="info-btn" onclick="toggleModal(true)">Настройки</div>
    </header>

    <div id="modalOverlay">
        <div class="max-w-xl mx-auto pb-20">
            <div class="flex justify-between items-center mb-10">
                <span class="section-label" style="margin-bottom:0">Конфигуратор</span>
                <button onclick="toggleModal(false)" class="text-3xl font-light p-2">&times;</button>
            </div>
            <div class="theme-switch-row">
                <span class="text-[0.65rem] font-bold uppercase tracking-widest">Черная тема (Инверсия)</span>
                <label class="custom-checkbox" style="padding:0" onclick="toggleContrast(event)">
                    <input type="checkbox" id="contrastToggle"><span class="checkmark" style="margin-right:0"></span>
                </label>
            </div>
            <div class="mb-10">
                <h3 class="section-label">Плетение натуральных дред</h3>
                <table class="settings-table">
                    <tr><td class="text-sm">База (до 10 см)</td><td><input type="number" id="price_base" value="300"> ₽</td></tr>
                    <tr><td class="text-sm">Шаг за каждые 10 см</td><td><input type="number" id="price_step" value="200"> ₽</td></tr>
                </table>
            </div>
            <div class="mb-10">
                <h3 class="section-label">Коррекция и дополнения</h3>
                <table class="settings-table">
                    <tr><td class="text-sm">Подплетение (база/шт)</td><td><input type="number" id="price_corr_base" value="150"> ₽</td></tr>
                    <tr><td class="text-sm">Тупой кончик (шт)</td><td><input type="number" id="price_blunt" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Сращивание (шт)</td><td><input type="number" id="price_fusion" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Корр. длины (за 10см)</td><td><input type="number" id="price_corr_len" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Прикорневое валяние (шт)</td><td><input type="number" id="price_root" value="30"> ₽</td></tr>
                </table>
            </div>
            <button onclick="saveSettings()" class="save-btn mb-12">Применить настройки</button>
        </div>
    </div>

    <main class="main-container">
        <span class="section-label">00. Категория работ</span>
        <div class="service-selector">
            <div id="typeCreation" class="service-option active" onclick="setService('creation', event)">Плетение</div>
            <div id="typeCorrection" class="service-option" onclick="setService('correction', event)">Подплетение</div>
        </div>
        <div class="input-group">
            <span class="section-label">01. Количество дред</span>
            <div class="flex items-baseline"><span id="countVal" class="display-value">50</span><span class="unit">шт</span></div>
            <input type="range" id="countRange" min="0" max="150" value="50">
        </div>
        <div id="groupLength" class="input-group">
            <span class="section-label">02. Общая длина</span>
            <div class="flex items-baseline"><span id="lengthVal" class="display-value">10</span><span class="unit">см</span></div>
            <input type="range" id="lengthRange" min="5" max="100" value="10">
        </div>
        <div id="groupAddons" class="input-group" style="border-bottom:none">
            <span class="section-label">03. Опции</span>
            <label class="custom-checkbox" onclick="handleCheck(event)">
                <input type="checkbox" id="bluntEndToggle"><span class="checkmark"></span>
                <span id="label_blunt" class="text-[0.65rem] font-bold uppercase tracking-widest">Тупой кончик</span>
            </label>
            <div id="bluntEndControl" class="sub-control">
                <div class="flex items-baseline"><span id="bluntCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="bluntCountRange" min="0" max="150" value="50">
            </div>
            <label class="custom-checkbox mt-2" onclick="handleCheck(event)">
                <input type="checkbox" id="fusionToggle"><span class="checkmark"></span>
                <span id="label_fusion" class="text-[0.65rem] font-bold uppercase tracking-widest">Сращивание</span>
            </label>
            <div id="fusionControl" class="sub-control">
                <div class="flex items-baseline"><span id="fusionCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="fusionCountRange" min="0" max="150" value="50">
            </div>
        </div>
        <div id="groupAddonsCorr" class="input-group hidden-element" style="border-bottom:none">
            <span class="section-label">03. Опции коррекции</span>
            <label class="custom-checkbox" onclick="handleCheck(event)">
                <input type="checkbox" id="corrLengthToggle"><span class="checkmark"></span>
                <span id="label_corr_len" class="text-[0.65rem] font-bold uppercase tracking-widest">Коррекция длины</span>
            </label>
            <div id="corrLengthControl" class="sub-control">
                <div class="mb-4">
                    <span class="section-label" style="font-size:0.5rem">Кол-во</span>
                    <div class="flex items-baseline"><span id="clcVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                    <input type="range" id="clcRange" min="0" max="150" value="50">
                </div>
                <div>
                    <span class="section-label" style="font-size:0.5rem">Коррекция по длине</span>
                    <div class="flex items-baseline"><span id="clcmVal" class="display-value text-2xl">10</span><span class="unit">см</span></div>
                    <input type="range" id="clcmRange" min="10" max="100" step="10" value="10">
                </div>
            </div>
            <label class="custom-checkbox mt-2" onclick="handleCheck(event)">
                <input type="checkbox" id="rootToggle"><span class="checkmark"></span>
                <span id="label_root" class="text-[0.65rem] font-bold uppercase tracking-widest">Прикорневое валяние</span>
            </label>
            <div id="rootControl" class="sub-control">
                <div class="flex items-baseline"><span id="rootCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="rootCountRange" min="0" max="150" value="50">
            </div>
        </div>
    </main>

    <div class="result-panel">
        <span class="section-label">Итоговая стоимость</span>
        <div class="flex items-baseline">
            <span id="totalPrice" class="price-display">0</span>
            <span class="text-xl font-light ml-4 opacity-50">₽</span>
        </div>
    </div>

    <script>
        // РЕГИСТРАЦИЯ SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Error: ', err));
            });
        }

        (function() {
            // --- ТЕМЫ ---
            window.toggleContrast = function(e) {
                if(e) e.stopPropagation();
                const isContrast = document.getElementById('contrastToggle').checked;
                document.body.classList.toggle('contrast-mode', isContrast);
                localStorage.setItem('dm_contrast', isContrast);
                pColor = isContrast ? '#FFFFFF' : '#111827';
                if(e) playBubbleSound();
            };

            const savedContrast = localStorage.getItem('dm_contrast') === 'true';
            if (document.getElementById('contrastToggle')) document.getElementById('contrastToggle').checked = savedContrast;
            document.body.classList.toggle('contrast-mode', savedContrast);
            let pColor = savedContrast ? '#FFFFFF' : '#111827';

            // --- БЕЗОПАСНОСТЬ И ТАЙМЕР ---
            let deviceId = localStorage.getItem('dm_device_id') || crypto.randomUUID();
            localStorage.setItem('dm_device_id', deviceId);
            if (document.getElementById('deviceIdLabel')) document.getElementById('deviceIdLabel').innerText = deviceId;

            let isActivated = localStorage.getItem('dm_active') === 'true';
            const DEMO_DURATION = 1800; // 30 минут

            window.initSecurity = async function() {
                if (isActivated) {
                    if (document.getElementById('demoTimer')) document.getElementById('demoTimer').style.display = 'none';
                    return;
                }
                
                const timerEl = document.getElementById('demoTimer');
                const lockOverlay = document.getElementById('lockOverlay');

                let firstLaunch;
                try {
                    const { db, appId, doc, getDoc, setDoc, auth, signInAnonymously } = window.firebaseTools;
                    if (!auth.currentUser) await signInAnonymously(auth);

                    const deviceRef = doc(db, 'artifacts', appId, 'public', 'data', 'devices', deviceId);
                    const snap = await getDoc(deviceRef);

                    if (snap.exists() && snap.data().firstLaunch) {
                        firstLaunch = snap.data().firstLaunch;
                    } else {
                        firstLaunch = Date.now();
                        await setDoc(deviceRef, { firstLaunch, deviceId, createdAt: new Date().toISOString() });
                        localStorage.setItem('dm_first_launch', firstLaunch);
                    }
                } catch (e) {
                    firstLaunch = parseInt(localStorage.getItem('dm_first_launch')) || Date.now();
                    localStorage.setItem('dm_first_launch', firstLaunch);
                }

                const runTimer = () => {
                    const now = Date.now();
                    const elapsed = Math.floor((now - firstLaunch) / 1000);
                    const timeLeft = Math.max(0, DEMO_DURATION - elapsed);
                    if (timeLeft <= 0) {
                        if (timerEl) timerEl.innerText = "DEMO 00:00";
                        if (lockOverlay) lockOverlay.style.display = 'flex';
                        return true;
                    }
                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    if (timerEl) timerEl.innerText = `DEMO ${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                    return false;
                };

                if (!runTimer()) setInterval(runTimer, 1000);
            };

            window.checkKey = async function() {
                const btn = document.getElementById('activateBtn');
                const errEl = document.getElementById('keyError');
                const key = document.getElementById('activationKey').value.trim().toUpperCase();
                if (!key) return;
                btn.disabled = true;
                btn.innerText = "Проверка...";
                try {
                    const { db, appId, doc, getDoc, updateDoc, auth, signInAnonymously } = window.firebaseTools;
                    if (!auth.currentUser) await signInAnonymously(auth);
                    const keyRef = doc(db, 'artifacts', appId, 'public', 'data', 'keys', key);
                    const snap = await getDoc(keyRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        if (!data.usedBy || data.usedBy === deviceId) {
                            await updateDoc(keyRef, { usedBy: deviceId, activatedAt: new Date().toISOString() });
                            localStorage.setItem('dm_active', 'true');
                            location.reload();
                        } else throw new Error("Ключ занят");
                    } else throw new Error("Неверный ключ");
                } catch (e) {
                    errEl.innerText = e.message;
                    errEl.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Активировать";
                }
            };

            // --- КАЛЬКУЛЯТОР ---
            let config = { price_base:300, price_step:200, price_corr_base:150, price_blunt:50, price_fusion:50, price_corr_len:50, price_root:30 };
            
            window.loadSettings = function() {
                const saved = localStorage.getItem('dm_cfg');
                if(saved) config = JSON.parse(saved);
                Object.keys(config).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = config[k]; });
                updateLabels();
            };

            window.saveSettings = function() {
                Object.keys(config).forEach(k => { 
                    const el = document.getElementById(k);
                    if (el) config[k] = parseInt(el.value) || 0; 
                });
                localStorage.setItem('dm_cfg', JSON.stringify(config));
                updateLabels(); calculateTotal(); toggleModal(false); playBubbleSound();
            };

            function updateLabels() {
                if (document.getElementById('label_blunt')) document.getElementById('label_blunt').innerText = `Тупой кончик (+${config.price_blunt}₽)`;
                if (document.getElementById('label_fusion')) document.getElementById('label_fusion').innerText = `Сращивание (+${config.price_fusion}₽)`;
                if (document.getElementById('label_corr_len')) document.getElementById('label_corr_len').innerText = `Длина (+${config.price_corr_len}₽)`;
                if (document.getElementById('label_root')) document.getElementById('label_root').innerText = `Прикорневое валяние (+${config.price_root}₽)`;
            }

            const canvas = document.getElementById('splatterCanvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
            window.onresize = resize; resize();
            
            class Particle {
                constructor(x,y) { this.x=x; this.y=y; this.s=Math.random()*2; this.vx=Math.random()*4-2; this.vy=Math.random()*4-2; this.o=1; }
                u() { this.x+=this.vx; this.y+=this.vy; this.o-=0.05; }
                d() { ctx.fillStyle=pColor; ctx.globalAlpha=this.o; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); }
            }

            let audioCtx;
            window.playBubbleSound = function() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400 + Math.random()*400, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            };

            window.triggerSplatter = function(e) {
                const r = e.target.getBoundingClientRect();
                for(let i=0; i<8; i++) particles.push(new Particle(r.left+r.width/2, r.top+r.height/2));
                playBubbleSound();
            };

            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles = particles.filter(p => p.o > 0);
                particles.forEach(p => { p.u(); p.d(); });
                requestAnimationFrame(animate);
            }
            animate();

            let currentService = 'creation';
            window.toggleModal = function(s) { document.getElementById('modalOverlay').style.display = s?'block':'none'; if(s) playBubbleSound(); };
            
            window.setService = function(t, e) {
                currentService = t;
                document.getElementById('typeCreation').classList.toggle('active', t==='creation');
                document.getElementById('typeCorrection').classList.toggle('active', t==='correction');
                document.getElementById('groupLength').classList.toggle('hidden-element', t==='correction');
                document.getElementById('groupAddons').classList.toggle('hidden-element', t==='correction');
                document.getElementById('groupAddonsCorr').classList.toggle('hidden-element', t==='creation');
                triggerSplatter(e); calculateTotal();
            };

            window.handleCheck = function(e) { triggerSplatter(e); setTimeout(calculateTotal, 50); };
            
            const uiIds = ['countRange','lengthRange','bluntCountRange','fusionCountRange','clcRange','clcmRange','rootCountRange','bluntEndToggle','fusionToggle','corrLengthToggle','rootToggle'];
            uiIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.oninput = (e) => { if(e.target.type==='range') playBubbleSound(); updateUI(); calculateTotal(); };
            });

            window.updateUI = function() {
                document.getElementById('countVal').innerText = document.getElementById('countRange').value;
                document.getElementById('lengthVal').innerText = document.getElementById('lengthRange').value;
                document.getElementById('bluntCountVal').innerText = document.getElementById('bluntCountRange').value;
                document.getElementById('fusionCountVal').innerText = document.getElementById('fusionCountRange').value;
                document.getElementById('clcVal').innerText = document.getElementById('clcRange').value;
                document.getElementById('clcmVal').innerText = document.getElementById('clcmRange').value;
                document.getElementById('rootCountVal').innerText = document.getElementById('rootCountRange').value;
                document.getElementById('bluntEndControl').classList.toggle('active', document.getElementById('bluntEndToggle').checked);
                document.getElementById('fusionControl').classList.toggle('active', document.getElementById('fusionToggle').checked);
                document.getElementById('corrLengthControl').classList.toggle('active', document.getElementById('corrLengthToggle').checked);
                document.getElementById('rootControl').classList.toggle('active', document.getElementById('rootToggle').checked);
            };

            window.calculateTotal = function() {
                let total = 0;
                const count = parseInt(document.getElementById('countRange').value);
                if(currentService === 'creation') {
                    const len = parseInt(document.getElementById('lengthRange').value);
                    let perUnit = config.price_base;
                    if(len > 10) perUnit += Math.ceil((len - 10) / 10) * config.price_step;
                    total = count * perUnit;
                    if(document.getElementById('bluntEndToggle').checked) total += parseInt(document.getElementById('bluntCountRange').value) * config.price_blunt;
                    if(document.getElementById('fusionToggle').checked) total += parseInt(document.getElementById('fusionCountRange').value) * config.price_fusion;
                } else {
                    total = count * config.price_corr_base;
                    if(document.getElementById('corrLengthToggle').checked) total += parseInt(document.getElementById('clcRange').value) * (parseInt(document.getElementById('clcmRange').value) / 10 * config.price_corr_len);
                    if(document.getElementById('rootToggle').checked) total += parseInt(document.getElementById('rootCountRange').value) * config.price_root;
                }
                const display = document.getElementById('totalPrice');
                const startVal = parseInt(display.innerText.replace(/\s/g, '')) || 0;
                const duration = 200, startTs = performance.now();
                function step(ts) {
                    const p = Math.min((ts - startTs) / duration, 1);
                    display.innerText = Math.floor(startVal + (total - startVal) * p).toLocaleString();
                    if(p < 1) requestAnimationFrame(step);
                }
                requestAnimationFrame(step);
            };

            window.onload = () => { 
                setTimeout(() => document.getElementById('preloader')?.classList.add('hidden'), 1500);
                loadSettings(); updateUI(); calculateTotal(); initSecurity(); 
                if (typeof vkBridge !== 'undefined') vkBridge.send('VKWebAppInit').catch(() => {});
            };
        })();
    </script>
</body>
</html>
