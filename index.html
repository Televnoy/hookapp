<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <title>Hook App | Professional Tool</title>
    
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
    
    <!-- PWA Assets -->
    <link rel="manifest" href='data:application/json;base64,ewogICJuYW1lIjogIkhvb2sgQXBwIiwKICAic2hvcnRfbmFtZSI6ICJIb29rIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNGRkZGRkYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTExODI3IiwKICAiaWNvbnMiOiBbCiAgICB7ICJzcmMiOiAiaWNvbi0xOC5wbmciLCAic2l6ZXMiOiAiMTh4MTgiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0zMi5wbmciLCAic2l6ZXMiOiAiMzJ4MzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi00OC5wbmciLCAic2l6ZXMiOiAiMzJ4MzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi03Mi5wbmciLCAic2l6ZXMiOiAiNzJ4NzIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi05Ni5wbmciLCAic2l6ZXMiOiAiOTZ4OTYiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0xNDQucG5nIiwgInNpemVzIjogIjE0NHgxNDQiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi0xOTIucG5nIiwgInNpemVzIjogIjE5MngxOTIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sCiAgICB7ICJzcmMiOiAiaWNvbi01MTIucG5nIiwgInNpemVzIjogIjUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0KICBdCn0='>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBk99RmIn2McXhLlMV4huc2iTUGONc7Zig",
            authDomain: "rootscalc-1c302.firebaseapp.com",
            projectId: "rootscalc-1c302",
            storageBucket: "rootscalc-1c302.firebasestorage.app",
            messagingSenderId: "466620468252",
            appId: "1:466620468252:web:e65ad3b731f4315f06a3d9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'rootscalc-pro';

        window.firebaseTools = { db, auth, appId, doc, getDoc, updateDoc, setDoc, signInAnonymously };
        signInAnonymously(auth).catch(err => console.error("Firebase Auth Error:", err.code));
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --charcoal: #111827; 
            --soft-gray: #9CA3AF; 
            --border: #E5E7EB; 
            --bg-main: #FFFFFF;
            --text-main: #111827;
            --panel-bg: #FFFFFF;
            --header-bg: rgba(255, 255, 255, 0.85);
            --thumb-bg: #FFFFFF;
        }

        body.contrast-mode {
            --bg-main: #000000;
            --text-main: #FFFFFF;
            --charcoal: #FFFFFF;
            --soft-gray: #6B7280;
            --border: #262626;
            --panel-bg: #000000;
            --header-bg: rgba(0, 0, 0, 0.85);
            --thumb-bg: #000000;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); margin: 0; padding: 0; overflow-x: hidden; user-select: none; -webkit-font-smoothing: antialiased; transition: background 0.3s, color 0.3s; }
        #splatterCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFFFFF; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #preloader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .spinner {
            width: 40px; height: 40px; border: 2px solid #f3f3f3;
            border-top: 2px solid #111827; border-radius: 50%;
            animation: spin 1s linear infinite; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sticky-header { position: sticky; top: 0; z-index: 50; background: var(--header-bg); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header-title { letter-spacing: 0.3em; text-transform: uppercase; font-weight: 700; font-size: 0.8rem; }
        .demo-timer { font-size: 0.7rem; font-weight: 700; color: #000000; letter-spacing: 0.1em; } 
        .info-btn { font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; border: 1px solid var(--charcoal); padding: 0.4rem 0.8rem; cursor: pointer; font-weight: 600; color: var(--text-main); }
        
        .main-container { max-width: 600px; margin: 0 auto; padding: 2rem 1.5rem 14rem; }
        
        #lockOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; text-align: center; }
        .key-input { width: 100%; max-width: 300px; border: 1px solid var(--charcoal); background: transparent; color: var(--text-main); padding: 1rem; margin: 1.5rem 0; text-align: center; font-family: monospace; letter-spacing: 2px; text-transform: uppercase; outline: none; }
        
        .section-label { letter-spacing: 0.25em; text-transform: uppercase; font-size: 0.6rem; font-weight: 600; color: var(--soft-gray); margin-bottom: 1.5rem; display: block; }
        .input-group { border-bottom: 1px solid var(--border); padding-bottom: 2rem; margin-bottom: 2rem; }
        
        .service-selector { display: flex; gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 3rem; }
        .service-option { flex: 1; background: var(--bg-main); padding: 1rem; text-align: center; cursor: pointer; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.15em; font-weight: 500; transition: all 0.2s; color: var(--text-main); }
        .service-option.active { background: var(--charcoal); color: var(--bg-main); }
        
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 1px; background: var(--border); outline: none; margin: 1.5rem 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--thumb-bg); border: 1px solid var(--charcoal); border-radius: 50%; cursor: pointer; }
        
        .display-value { font-weight: 100; font-size: 3.5rem; line-height: 1; letter-spacing: -0.02em; }
        .unit { font-size: 0.9rem; color: var(--soft-gray); margin-left: 0.5rem; font-weight: 300; }
        
        .custom-checkbox { display: flex; align-items: center; cursor: pointer; padding: 0.75rem 0; }
        .custom-checkbox input { display: none; }
        .checkmark { width: 20px; height: 20px; border: 1px solid var(--charcoal); margin-right: 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .custom-checkbox input:checked + .checkmark { background: var(--charcoal); }
        .custom-checkbox input:checked + .checkmark::after { content: ''; width: 6px; height: 6px; background: var(--bg-main); }
        
        .sub-control { max-height: 0; overflow: hidden; padding-left: 2rem; border-left: 1px solid var(--border); opacity: 0; transition: all 0.4s ease; }
        .sub-control.active { max-height: 500px; opacity: 1; margin-top: 1rem; margin-bottom: 2rem; }
        
        .result-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel-bg); border-top: 1px solid var(--charcoal); padding: 2rem 1.5rem calc(2rem + env(safe-area-inset-bottom)); max-width: 600px; margin: 0 auto; z-index: 40; }
        .price-display { font-weight: 100; font-size: 4rem; letter-spacing: -0.05em; line-height: 1; }
        
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 100; display: none; overflow-y: auto; padding: 2rem 1.5rem; color: var(--text-main); }
        .settings-table { width: 100%; margin-bottom: 2rem; }
        .settings-table td { padding: 0.8rem 0; border-bottom: 1px solid var(--border); }
        .settings-table input { width: 80px; border: 1px solid var(--border); background: transparent; color: var(--text-main); padding: 0.3rem; text-align: right; font-weight: 600; outline: none; }
        
        .save-btn { background: var(--charcoal); color: var(--bg-main); width: 100%; padding: 1.2rem; text-transform: uppercase; letter-spacing: 0.2em; font-size: 0.75rem; font-weight: 700; transition: opacity 0.2s; }
        .save-btn:active { opacity: 0.7; }
        .hidden-element { display: none !important; }
        .theme-switch-row { display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 0; border-bottom: 1px solid var(--border); margin-bottom: 2.5rem; }
    </style>
</head>
<body>

    <div id="preloader">
        <svg class="loader-logo" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="60" height="60" viewBox="0 0 75 420" fill="none">
    <path d="M66.38 116.23c-.11-4.16-.31-8.32-.54-12.48-.2-3.6-.6-7.19-.76-10.79-.24-5.18-.61-10.34-1.21-15.48-.53-4.55-.93-9.11-1.39-13.66-.64-6.31-1.64-12.56-2.58-18.82-.61-4.11-1.56-8.17-2.41-12.24-.35-1.67-.65-3.35-1.26-4.96-.06-.41-.07-.84-.18-1.23-1.42-4.79-2.74-9.62-5.16-14.04-1.11-2.02-2.19-4.07-3.6-5.91-.48-1.08-1.48-1.67-2.3-2.43-.11-.37-.41-.51-.74-.62-.61-.5-1.12-1.12-1.9-1.38-.59-.51-1.22-.93-2-1.08-1.79-.7-3.61-1.24-5.58-1.07-1.04.09-2.1.01-3.15.02-.45 0-.92-.06-1.34.19-.39.03-.79 0-1.12.29-1.02.16-1.97.5-2.83 1.09-.65.07-1.12.47-1.58.88-.97.48-1.75 1.2-2.53 1.94-.27.07-.44.25-.56.5-.64.57-1.4 1.05-1.69 1.93-1.24 1.6-2.48 3.19-3.35 5.03-.33.3-.44.7-.54 1.11q-.09.165-.15.33c-.49 1.06-1.04 2.11-1.4 3.21-1.04 3.15-2.11 6.29-3.11 9.46-1.07 3.4-1.85 6.86-2.56 10.34-.36 1.76-.88 3.49-1.13 5.27-.49 3.43-1.01 6.85-1.49 10.28-.29 2.06-.71 4.1-.71 6.19-.11.54-.23 1.08-.31 1.63-.52 3.47-.95 6.96-1.25 10.46-.34 3.96-.76 7.91-1.11 11.87-.24 2.77-.33 5.54-.63 8.3C1.41 98 1.2 105.68.82 113.34c-.17 3.33-.21 6.66-.35 9.98-.19 4.48-.48 8.96-.46 13.44.04 11.57-.2 23.13.23 34.7.11 3.05.2 6.1.36 9.15.1 1.94.14 3.88.26 5.82.49 7.34 1.34 14.64 2.02 21.97.16 1.69.17 3.41.7 5.06-.07 1.31.24 2.58.42 3.85.48 3.38 1.08 6.75 1.59 10.13 1.05 6.94 2.04 13.9 3.14 20.84.78 4.93 1.56 9.86 2.29 14.8.67 4.53 1.05 9.08 1.55 13.63.91 8.28 1.29 16.59 1.71 24.91.14 2.77.27 5.54.41 8.31-.02.51-.06 1.02-.04 1.52.29 11.19.57 22.38.88 33.58.1 3.56.1 7.12.24 10.68.19 4.76.25 9.53.64 14.28.26 3.14.18 6.29.53 9.42.32 2.94.6 5.89.95 8.83.39 3.26.87 6.5 1.52 9.72.19 2.12.74 4.18 1.17 6.26 1.32 6.39 3.15 12.64 5.23 18.81.25.74.39 1.52.84 2.19.9 2.62 1.82 5.24 3.08 7.72 1.76 3.47 3.11 7.11 4.75 10.63 2.1 4.49 3.75 9.15 4.41 14.1.02.54.07 1.07.04 1.6-.04.83-.17.88-1.09.58-.04-.52-.22-.98-.59-1.36-1.07-2.55-3.28-3.82-5.6-4.96-.64-.32-1.4-.37-1.98-.83-.19-.3-.52-.37-.82-.44-2.02-.45-3.99-.41-5.85.64-.63.3-1.38.33-1.9.85-.89.6-1.82 1.15-2.23 2.23-.6.6-1.01 1.3-1.11 2.15-.87 1.82-1.27 3.76-1.33 5.77-.12 3.97.71 7.82 1.65 11.65.84 3.4 2.45 6.48 4 9.59 1.4 2.79 3.26 5.17 5.91 6.85 2.3 1.47 4.72 2.09 7.33.74 2.09-.59 3.4-2.19 4.48-3.88.72-1.14 1.23-2.47 1.6-3.81.57-2.09 1.19-4.16 1.72-6.26.57-2.28.98-4.59 1.12-6.94.52-2.19.84-4.41.84-6.66.32-.79.27-1.61.27-2.43.25-.42.22-.89.28-1.35.51-3.63.61-7.29.93-10.93.46-5.16.92-10.32 1.35-15.49.28-3.37.35-6.75.72-10.11.23-2.07.38-4.15.51-6.22.24-3.97.4-7.95.65-11.92.49-7.67 1.06-15.33 1.38-23 .39-9.43.75-18.87.88-28.31.07-5.51.1-11.02.28-16.52.29-9.25.17-18.51.66-27.76.22-4.15.26-8.33.38-12.49.07-2.31.28-4.62.4-6.92.15-2.91.54-5.8.46-8.72.09-.38.12-.77.14-1.16.17-1.45.35-2.89.47-4.35.61-7.28 1.52-14.52 2.51-21.75.83-6.04 1.67-12.08 2.84-18.07.14-.73.24-1.46.16-2.2.22-.27.21-.6.26-.92.49-3.34.91-6.69 1.5-10.01 1.12-6.29 1.61-12.66 2.41-18.99.31-2.47.38-4.98.58-7.46.31-3.82.76-7.64.93-11.47.32-7.3.55-14.61.71-21.92.13-5.65.15-11.29.13-16.94-.03-10.51-.2-21.01-.48-31.51Zm-43.3 134.16s-.03-.02-.04-.03h.04zM41.14 369v-.04.04m-18.06-27.62v-.11zm31.4-129.94v.01zM16.41 254.8v.02zm32.51 28.09h-.02s.01-.02.02-.03v.02ZM30.18.35s-.07.03-.11.04c.06-.03.11-.06.16-.1-.02.02-.04.04-.05.06" fill="#111827"></path>
        </svg>
        <div class="header-title mt-4" style="color: #111827">hook app</div>
        <div class="spinner"></div>
    </div>

    <canvas id="splatterCanvas"></canvas>

    <div id="lockOverlay">
        <div class="header-title mb-8">hook app</div>
        <p class="text-xs uppercase tracking-widest text-gray-400 mb-2">Пробный период завершен</p>
        <h2 class="text-xl font-light mb-6">Активация устройства</h2>
        <input type="text" id="activationKey" class="key-input" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
        <button id="activateBtn" onclick="checkKey()" class="save-btn max-w-[300px]">Активировать</button>
        <p id="keyError" class="mt-4 text-[10px] text-red-500 uppercase tracking-widest hidden">Ошибка</p>
        <div class="mt-10 pt-10 border-t w-full max-w-[300px] border-border">
            <p class="text-[9px] uppercase tracking-widest text-gray-400">ID устройства:</p>
            <p id="deviceIdLabel" class="text-[9px] font-mono mt-1 opacity-50">загрузка...</p>
        </div>
    </div>

    <header class="sticky-header">
        <div class="header-title">hook app</div>
        <div id="demoTimer" class="demo-timer">DEMO 30:00</div>
        <div class="info-btn" onclick="toggleModal(true)">Настройки</div>
    </header>

    <div id="modalOverlay">
        <div class="max-w-xl mx-auto pb-20">
            <div class="flex justify-between items-center mb-10">
                <span class="section-label" style="margin-bottom:0">Конфигуратор</span>
                <button onclick="toggleModal(false)" class="text-3xl font-light p-2">&times;</button>
            </div>
            <div class="theme-switch-row">
                <span class="text-[0.65rem] font-bold uppercase tracking-widest">Черная тема (Инверсия)</span>
                <label class="custom-checkbox" style="padding:0" onclick="toggleContrast(event)">
                    <input type="checkbox" id="contrastToggle"><span class="checkmark" style="margin-right:0"></span>
                </label>
            </div>
            <div class="mb-10">
                <h3 class="section-label">Плетение натуральных дред</h3>
                <table class="settings-table">
                    <tr><td class="text-sm">База (до 10 см)</td><td><input type="number" id="price_base" value="300"> ₽</td></tr>
                    <tr><td class="text-sm">Шаг за каждые 10 см</td><td><input type="number" id="price_step" value="200"> ₽</td></tr>
                </table>
            </div>
            <div class="mb-10">
                <h3 class="section-label">Коррекция и дополнения</h3>
                <table class="settings-table">
                    <tr><td class="text-sm">Подплетение (база/шт)</td><td><input type="number" id="price_corr_base" value="150"> ₽</td></tr>
                    <tr><td class="text-sm">Тупой кончик (шт)</td><td><input type="number" id="price_blunt" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Сращивание (шт)</td><td><input type="number" id="price_fusion" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Корр. длины (за 10см)</td><td><input type="number" id="price_corr_len" value="50"> ₽</td></tr>
                    <tr><td class="text-sm">Прикорневое валяние (шт)</td><td><input type="number" id="price_root" value="30"> ₽</td></tr>
                </table>
            </div>
            <button onclick="saveSettings()" class="save-btn mb-12">Применить настройки</button>
        </div>
    </div>

    <main class="main-container">
        <span class="section-label">00. Категория работ</span>
        <div class="service-selector">
            <div id="typeCreation" class="service-option active" onclick="setService('creation', event)">Плетение</div>
            <div id="typeCorrection" class="service-option" onclick="setService('correction', event)">Подплетение</div>
        </div>
        <div class="input-group">
            <span class="section-label">01. Количество дред</span>
            <div class="flex items-baseline"><span id="countVal" class="display-value">50</span><span class="unit">шт</span></div>
            <input type="range" id="countRange" min="0" max="150" value="50">
        </div>
        <div id="groupLength" class="input-group">
            <span class="section-label">02. Общая длина</span>
            <div class="flex items-baseline"><span id="lengthVal" class="display-value">10</span><span class="unit">см</span></div>
            <input type="range" id="lengthRange" min="5" max="100" value="10">
        </div>
        <div id="groupAddons" class="input-group" style="border-bottom:none">
            <span class="section-label">03. Опции</span>
            <label class="custom-checkbox" onclick="handleCheck(event)">
                <input type="checkbox" id="bluntEndToggle"><span class="checkmark"></span>
                <span id="label_blunt" class="text-[0.65rem] font-bold uppercase tracking-widest">Тупой кончик</span>
            </label>
            <div id="bluntEndControl" class="sub-control">
                <div class="flex items-baseline"><span id="bluntCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="bluntCountRange" min="0" max="150" value="50">
            </div>
            <label class="custom-checkbox mt-2" onclick="handleCheck(event)">
                <input type="checkbox" id="fusionToggle"><span class="checkmark"></span>
                <span id="label_fusion" class="text-[0.65rem] font-bold uppercase tracking-widest">Сращивание</span>
            </label>
            <div id="fusionControl" class="sub-control">
                <div class="flex items-baseline"><span id="fusionCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="fusionCountRange" min="0" max="150" value="50">
            </div>
        </div>
        <div id="groupAddonsCorr" class="input-group hidden-element" style="border-bottom:none">
            <span class="section-label">03. Опции коррекции</span>
            <label class="custom-checkbox" onclick="handleCheck(event)">
                <input type="checkbox" id="corrLengthToggle"><span class="checkmark"></span>
                <span id="label_corr_len" class="text-[0.65rem] font-bold uppercase tracking-widest">Коррекция длины</span>
            </label>
            <div id="corrLengthControl" class="sub-control">
                <div class="mb-4">
                    <span class="section-label" style="font-size:0.5rem">Кол-во</span>
                    <div class="flex items-baseline"><span id="clcVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                    <input type="range" id="clcRange" min="0" max="150" value="50">
                </div>
                <div>
                    <span class="section-label" style="font-size:0.5rem">Коррекция по длине</span>
                    <div class="flex items-baseline"><span id="clcmVal" class="display-value text-2xl">10</span><span class="unit">см</span></div>
                    <input type="range" id="clcmRange" min="10" max="100" step="10" value="10">
                </div>
            </div>
            <label class="custom-checkbox mt-2" onclick="handleCheck(event)">
                <input type="checkbox" id="rootToggle"><span class="checkmark"></span>
                <span id="label_root" class="text-[0.65rem] font-bold uppercase tracking-widest">Прикорневое валяние</span>
            </label>
            <div id="rootControl" class="sub-control">
                <div class="flex items-baseline"><span id="rootCountVal" class="display-value text-2xl">50</span><span class="unit">шт</span></div>
                <input type="range" id="rootCountRange" min="0" max="150" value="50">
            </div>
        </div>
    </main>

    <div class="result-panel">
        <span class="section-label">Итоговая стоимость</span>
        <div class="flex items-baseline">
            <span id="totalPrice" class="price-display">0</span>
            <span class="text-xl font-light ml-4 opacity-50">₽</span>
        </div>
    </div>

    <script>
        // РЕГИСТРАЦИЯ SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Error: ', err));
            });
        }

        (function() {
            // --- ТЕМЫ ---
            window.toggleContrast = function(e) {
                if(e) e.stopPropagation();
                const isContrast = document.getElementById('contrastToggle').checked;
                document.body.classList.toggle('contrast-mode', isContrast);
                localStorage.setItem('dm_contrast', isContrast);
                pColor = isContrast ? '#FFFFFF' : '#111827';
                if(e) playBubbleSound();
            };

            const savedContrast = localStorage.getItem('dm_contrast') === 'true';
            if (document.getElementById('contrastToggle')) document.getElementById('contrastToggle').checked = savedContrast;
            document.body.classList.toggle('contrast-mode', savedContrast);
            let pColor = savedContrast ? '#FFFFFF' : '#111827';

            // --- БЕЗОПАСНОСТЬ И ТАЙМЕР ---
            let deviceId = localStorage.getItem('dm_device_id') || crypto.randomUUID();
            localStorage.setItem('dm_device_id', deviceId);
            if (document.getElementById('deviceIdLabel')) document.getElementById('deviceIdLabel').innerText = deviceId;

            let isActivated = localStorage.getItem('dm_active') === 'true';
            const DEMO_DURATION = 1800; // 30 минут

            window.initSecurity = async function() {
                if (isActivated) {
                    if (document.getElementById('demoTimer')) document.getElementById('demoTimer').style.display = 'none';
                    return;
                }
                
                const timerEl = document.getElementById('demoTimer');
                const lockOverlay = document.getElementById('lockOverlay');

                let firstLaunch;
                try {
                    const { db, appId, doc, getDoc, setDoc, auth, signInAnonymously } = window.firebaseTools;
                    if (!auth.currentUser) await signInAnonymously(auth);

                    const deviceRef = doc(db, 'artifacts', appId, 'public', 'data', 'devices', deviceId);
                    const snap = await getDoc(deviceRef);

                    if (snap.exists() && snap.data().firstLaunch) {
                        firstLaunch = snap.data().firstLaunch;
                    } else {
                        firstLaunch = Date.now();
                        await setDoc(deviceRef, { firstLaunch, deviceId, createdAt: new Date().toISOString() });
                        localStorage.setItem('dm_first_launch', firstLaunch);
                    }
                } catch (e) {
                    firstLaunch = parseInt(localStorage.getItem('dm_first_launch')) || Date.now();
                    localStorage.setItem('dm_first_launch', firstLaunch);
                }

                const runTimer = () => {
                    const now = Date.now();
                    const elapsed = Math.floor((now - firstLaunch) / 1000);
                    const timeLeft = Math.max(0, DEMO_DURATION - elapsed);
                    if (timeLeft <= 0) {
                        if (timerEl) timerEl.innerText = "DEMO 00:00";
                        if (lockOverlay) lockOverlay.style.display = 'flex';
                        return true;
                    }
                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    if (timerEl) timerEl.innerText = `DEMO ${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                    return false;
                };

                if (!runTimer()) setInterval(runTimer, 1000);
            };

            window.checkKey = async function() {
                const btn = document.getElementById('activateBtn');
                const errEl = document.getElementById('keyError');
                const key = document.getElementById('activationKey').value.trim().toUpperCase();
                if (!key) return;
                btn.disabled = true;
                btn.innerText = "Проверка...";
                try {
                    const { db, appId, doc, getDoc, updateDoc, auth, signInAnonymously } = window.firebaseTools;
                    if (!auth.currentUser) await signInAnonymously(auth);
                    const keyRef = doc(db, 'artifacts', appId, 'public', 'data', 'keys', key);
                    const snap = await getDoc(keyRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        if (!data.usedBy || data.usedBy === deviceId) {
                            await updateDoc(keyRef, { usedBy: deviceId, activatedAt: new Date().toISOString() });
                            localStorage.setItem('dm_active', 'true');
                            location.reload();
                        } else throw new Error("Ключ занят");
                    } else throw new Error("Неверный ключ");
                } catch (e) {
                    errEl.innerText = e.message;
                    errEl.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Активировать";
                }
            };

            // --- КАЛЬКУЛЯТОР ---
            let config = { price_base:300, price_step:200, price_corr_base:150, price_blunt:50, price_fusion:50, price_corr_len:50, price_root:30 };
            
            window.loadSettings = function() {
                const saved = localStorage.getItem('dm_cfg');
                if(saved) config = JSON.parse(saved);
                Object.keys(config).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = config[k]; });
                updateLabels();
            };

            window.saveSettings = function() {
                Object.keys(config).forEach(k => { 
                    const el = document.getElementById(k);
                    if (el) config[k] = parseInt(el.value) || 0; 
                });
                localStorage.setItem('dm_cfg', JSON.stringify(config));
                updateLabels(); calculateTotal(); toggleModal(false); playBubbleSound();
            };

            function updateLabels() {
                if (document.getElementById('label_blunt')) document.getElementById('label_blunt').innerText = `Тупой кончик (+${config.price_blunt}₽)`;
                if (document.getElementById('label_fusion')) document.getElementById('label_fusion').innerText = `Сращивание (+${config.price_fusion}₽)`;
                if (document.getElementById('label_corr_len')) document.getElementById('label_corr_len').innerText = `Длина (+${config.price_corr_len}₽)`;
                if (document.getElementById('label_root')) document.getElementById('label_root').innerText = `Прикорневое валяние (+${config.price_root}₽)`;
            }

            const canvas = document.getElementById('splatterCanvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
            window.onresize = resize; resize();
            
            class Particle {
                constructor(x,y) { this.x=x; this.y=y; this.s=Math.random()*2; this.vx=Math.random()*4-2; this.vy=Math.random()*4-2; this.o=1; }
                u() { this.x+=this.vx; this.y+=this.vy; this.o-=0.05; }
                d() { ctx.fillStyle=pColor; ctx.globalAlpha=this.o; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); }
            }

            let audioCtx;
            window.playBubbleSound = function() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400 + Math.random()*400, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            };

            window.triggerSplatter = function(e) {
                const r = e.target.getBoundingClientRect();
                for(let i=0; i<8; i++) particles.push(new Particle(r.left+r.width/2, r.top+r.height/2));
                playBubbleSound();
            };

            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles = particles.filter(p => p.o > 0);
                particles.forEach(p => { p.u(); p.d(); });
                requestAnimationFrame(animate);
            }
            animate();

            let currentService = 'creation';
            window.toggleModal = function(s) { document.getElementById('modalOverlay').style.display = s?'block':'none'; if(s) playBubbleSound(); };
            
            window.setService = function(t, e) {
                currentService = t;
                document.getElementById('typeCreation').classList.toggle('active', t==='creation');
                document.getElementById('typeCorrection').classList.toggle('active', t==='correction');
                document.getElementById('groupLength').classList.toggle('hidden-element', t==='correction');
                document.getElementById('groupAddons').classList.toggle('hidden-element', t==='correction');
                document.getElementById('groupAddonsCorr').classList.toggle('hidden-element', t==='creation');
                triggerSplatter(e); calculateTotal();
            };

            window.handleCheck = function(e) { triggerSplatter(e); setTimeout(calculateTotal, 50); };
            
            const uiIds = ['countRange','lengthRange','bluntCountRange','fusionCountRange','clcRange','clcmRange','rootCountRange','bluntEndToggle','fusionToggle','corrLengthToggle','rootToggle'];
            uiIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.oninput = (e) => { if(e.target.type==='range') playBubbleSound(); updateUI(); calculateTotal(); };
            });

            window.updateUI = function() {
                document.getElementById('countVal').innerText = document.getElementById('countRange').value;
                document.getElementById('lengthVal').innerText = document.getElementById('lengthRange').value;
                document.getElementById('bluntCountVal').innerText = document.getElementById('bluntCountRange').value;
                document.getElementById('fusionCountVal').innerText = document.getElementById('fusionCountRange').value;
                document.getElementById('clcVal').innerText = document.getElementById('clcRange').value;
                document.getElementById('clcmVal').innerText = document.getElementById('clcmRange').value;
                document.getElementById('rootCountVal').innerText = document.getElementById('rootCountRange').value;
                document.getElementById('bluntEndControl').classList.toggle('active', document.getElementById('bluntEndToggle').checked);
                document.getElementById('fusionControl').classList.toggle('active', document.getElementById('fusionToggle').checked);
                document.getElementById('corrLengthControl').classList.toggle('active', document.getElementById('corrLengthToggle').checked);
                document.getElementById('rootControl').classList.toggle('active', document.getElementById('rootToggle').checked);
            };

            window.calculateTotal = function() {
                let total = 0;
                const count = parseInt(document.getElementById('countRange').value);
                if(currentService === 'creation') {
                    const len = parseInt(document.getElementById('lengthRange').value);
                    let perUnit = config.price_base;
                    if(len > 10) perUnit += Math.ceil((len - 10) / 10) * config.price_step;
                    total = count * perUnit;
                    if(document.getElementById('bluntEndToggle').checked) total += parseInt(document.getElementById('bluntCountRange').value) * config.price_blunt;
                    if(document.getElementById('fusionToggle').checked) total += parseInt(document.getElementById('fusionCountRange').value) * config.price_fusion;
                } else {
                    total = count * config.price_corr_base;
                    if(document.getElementById('corrLengthToggle').checked) total += parseInt(document.getElementById('clcRange').value) * (parseInt(document.getElementById('clcmRange').value) / 10 * config.price_corr_len);
                    if(document.getElementById('rootToggle').checked) total += parseInt(document.getElementById('rootCountRange').value) * config.price_root;
                }
                const display = document.getElementById('totalPrice');
                const startVal = parseInt(display.innerText.replace(/\s/g, '')) || 0;
                const duration = 200, startTs = performance.now();
                function step(ts) {
                    const p = Math.min((ts - startTs) / duration, 1);
                    display.innerText = Math.floor(startVal + (total - startVal) * p).toLocaleString();
                    if(p < 1) requestAnimationFrame(step);
                }
                requestAnimationFrame(step);
            };

            window.onload = () => { 
                setTimeout(() => document.getElementById('preloader')?.classList.add('hidden'), 1500);
                loadSettings(); updateUI(); calculateTotal(); initSecurity(); 
                if (typeof vkBridge !== 'undefined') vkBridge.send('VKWebAppInit').catch(() => {});
            };
        })();
    </script>
</body>
</html>
